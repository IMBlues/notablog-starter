{"children":[{"children":[],"uri":"https://www.notion.so/d5af5c5f6035457082ad1ef23502c58b","type":"text","createdTime":1606472640000,"lastEditedTime":1606472640000,"title":[]},{"children":[],"uri":"https://www.notion.so/77815a7a9a684bf88af5b1a0269d6f24","type":"table_of_contents","color":"gray","createdTime":1596426342346,"lastEditedTime":1596426300000},{"children":[],"uri":"https://www.notion.so/91c3effb15414d7c8fc42c7ebf3205ad","type":"text","createdTime":1602489120000,"lastEditedTime":1602489120000,"title":[]},{"children":[],"uri":"https://www.notion.so/3fd7584acb8349f68f49eae2011e85b4","type":"text","createdTime":1596426300000,"lastEditedTime":1605172920000,"title":[]},{"children":[],"uri":"https://www.notion.so/5061352e79dd425c87e1399aea569e0b","type":"heading","createdTime":1591866691299,"lastEditedTime":1606463640000,"title":[["QuerySet",[["c",null]]],[" 的类型陷阱"]],"depth":2},{"children":[],"uri":"https://www.notion.so/4cd5a45cce1e4da79913a33bd8d63f86","type":"text","createdTime":1591866960000,"lastEditedTime":1591866960000,"title":[]},{"children":[],"uri":"https://www.notion.so/df75d8d0b3d445e49b4c73812387aa2b","type":"heading","createdTime":1591867008019,"lastEditedTime":1596426360000,"title":[["有时候希望它是简单类型"]],"depth":3},{"children":[],"uri":"https://www.notion.so/a912bf667c054c3ca428ab2fb9106254","type":"text","createdTime":1591866660000,"lastEditedTime":1591866900000,"title":[["而 "],["objects.values()",[["c",null]]],[" 返回的并不是数据，而是 "],["QuerySet",[["c",null]]],["。一般用来做 "],["Response",[["c",null]]],[" 没有问题，但是 "],["QuerySet",[["c",null]]],[" 是不能被 "],["pickle",[["c",null]]],[" 的，如果使用到 "],["Django Cache",[["c",null]]],[" 之类功能，会直接报错。"]]},{"children":[],"uri":"https://www.notion.so/6b61bc0c702140f9885370958bcbd225","type":"text","createdTime":1591866960000,"lastEditedTime":1591866960000,"title":[]},{"children":[],"uri":"https://www.notion.so/325da1843c9c4c7dad776b90d99a3d57","type":"heading","createdTime":1591867023047,"lastEditedTime":1596426360000,"title":[["有时候希望它仍旧是 "],["QuerySet",[["c",null]]]],"depth":3},{"children":[],"uri":"https://www.notion.so/c0ca1caeb6274a959a8ddd5430d9ced6","type":"text","createdTime":1591866869403,"lastEditedTime":1591866900000,"title":[["很多时候我们需要限制 "],["QuerySet",[["c",null]]],[" 返回的字段以加快 DB 查询的速度（比如一些没索引的长字段)，这时候可能的两个方法： "],["only()",[["c",null]]],[" & "],["values()",[["c",null]]],[" 。"]]},{"children":[],"uri":"https://www.notion.so/cf3b0e88064443de9896a46218f0656f","type":"text","createdTime":1591866869403,"lastEditedTime":1591866960000,"title":[["但实际情况是，使用需要注意， "],["values()",[["c",null]]],[" 会改变 "],["queryset._iterable_class",[["c",null]]],[" ，如果后面还有 "],["queryset",[["c",null]]],[" 的级联查询，会导致最后的结果为 "],["Dict",[["c",null]]],[" 而不是 "],["QuerySet",[["c",null]]]]},{"children":[],"uri":"https://www.notion.so/8dc0b87c1e5a4e45af3488680bd43795","type":"text","createdTime":1605172800000,"lastEditedTime":1605172800000,"title":[]},{"children":[],"uri":"https://www.notion.so/af6e5f51d5ed4a97a92b9ce98010f245","type":"text","createdTime":1605172800000,"lastEditedTime":1605172920000,"title":[]},{"children":[],"uri":"https://www.notion.so/75a67352f55148989cf9045b9a6b804b","type":"text","createdTime":1596426360000,"lastEditedTime":1596426360000,"title":[]},{"children":[],"uri":"https://www.notion.so/606ad655f4ad4f4da7188aab9cfc86bd","type":"divider","createdTime":1595901660000,"lastEditedTime":1596426360000},{"children":[],"uri":"https://www.notion.so/7afd58ae9a8244b29df5e6b8954931c7","type":"heading","createdTime":1591867020000,"lastEditedTime":1605172920000,"title":[["巧用 extra "]],"depth":2},{"children":[],"uri":"https://www.notion.so/8cb4b9939a7b4ed0a67424076db809e8","type":"bookmark","createdTime":1595901660000,"lastEditedTime":1595901660000,"link":"https://docs.djangoproject.com/en/1.11/ref/models/querysets/#extra","title":"QuerySet API reference | Django documentation | Django","description":"Django provides a range of refinement methods that modify either the types of results returned by the or the way its SQL query is executed. Returns a new containing objects that do not match the given lookup parameters. The lookup parameters () should be in the format described in Field lookups below.","icon":"https://static.djangoproject.com/img/favicon.6dbf28c0650e.ico"},{"children":[],"uri":"https://www.notion.so/e6523e5eedca449d8f8add3945c94331","type":"text","createdTime":1595901720000,"lastEditedTime":1595901720000,"title":[]},{"children":[],"uri":"https://www.notion.so/420fed93f5dd422fa5b8b31c69ddc06b","type":"text","createdTime":1595901720000,"lastEditedTime":1595901780000,"title":[["extra()",[["c",null]]],[" 可以利用 "],["sql",[["c",null]]],[" 在数据库中做数据处理，而不用放到内存中，在数据量较大时有比较好的效果，比如："]]},{"children":[],"uri":"https://www.notion.so/c87aaae9e64a4dc3a9152cec45112964","type":"text","createdTime":1595901780000,"lastEditedTime":1595901780000,"title":[]},{"children":[],"uri":"https://www.notion.so/4dca08f0298141fd8d4aa70947f1cbbf","type":"code","createdTime":1595901780000,"lastEditedTime":1595901780000,"title":[["queryset = queryset.extra(select={'username': \"CONCAT(username, '@', domain)\"})"]],"language":"Python","wrap":true},{"children":[],"uri":"https://www.notion.so/b4b65f47c26141eeb123d59491c78241","type":"text","createdTime":1605844740000,"lastEditedTime":1605844740000,"title":[]},{"children":[],"uri":"https://www.notion.so/ad670af14adb4309a53817b1b9180716","type":"text","createdTime":1605843180000,"lastEditedTime":1605844740000,"title":[["在模糊查询时，匹配最短结果"]]},{"children":[],"uri":"https://www.notion.so/ad09a005a149471795a5464090a14de0","type":"code","createdTime":1605172860000,"lastEditedTime":1605843240000,"title":[["MyModel.objects.extra(select={'myfield_length':'Length(myfield)'}).order_by('myfield_length')"]],"language":"Python","wrap":true},{"children":[],"uri":"https://www.notion.so/5ee8e4a7a5414262b2a45f89a25e91e9","type":"divider","createdTime":1595908440000,"lastEditedTime":1596426360000},{"children":[],"uri":"https://www.notion.so/2df130b58b64487c9a39d07a7dd37219","type":"heading","createdTime":1595907720000,"lastEditedTime":1596426300000,"title":[["JsonField",[["c",null]]],[" 的福音—— "],["JSON_SEARCH",[["c",null]]]],"depth":2},{"children":[],"uri":"https://www.notion.so/f77a65c8d4594c4ea7bae43954130581","type":"text","createdTime":1595907720000,"lastEditedTime":1595907840000,"title":[["有时候我们需要使用动态字段，并且保证动态字段的值全表唯一。动态字段我们使用 "],["LONGTEXT",[["c",null]]],[" 存储，格式为 "],["JSON",[["c",null]]],[" 。如果手动处理，需要将整个表的字段放到内存，并做唯一校验，非常麻烦且耗时。"]]},{"children":[],"uri":"https://www.notion.so/07d0639e87784d8eb0ea41ac07541402","type":"text","createdTime":1595907840000,"lastEditedTime":1595907840000,"title":[["所以还是一个道理，把这个逻辑交给 DB"]]},{"children":[],"uri":"https://www.notion.so/7fe9007cbef74afd8b556bc4ff5c46b6","type":"code","createdTime":1595907840000,"lastEditedTime":1595907840000,"title":[["select * from profiles_profile where JSON_SEARCH(extras, \"one\", \"aaa\") is not null;"]],"language":"SQL","wrap":true},{"children":[],"uri":"https://www.notion.so/6f5fa319ca16451f8b0f425ad9f46c7c","type":"text","createdTime":1597825020000,"lastEditedTime":1597825020000,"title":[]},{"children":[],"uri":"https://www.notion.so/9352e20872294077afce192e846c2d4a","type":"divider","createdTime":1597825040955,"lastEditedTime":1597825020000},{"children":[],"uri":"https://www.notion.so/629ff8f8781441ab88c2660f3b111219","type":"heading","createdTime":1595907720000,"lastEditedTime":1605172980000,"title":[["行锁"]],"depth":2},{"children":[],"uri":"https://www.notion.so/84a186a384574bbb93ae8fc1bee2ab05","type":"text","createdTime":1597824840000,"lastEditedTime":1597824900000,"title":[["多个操作互斥的情况下，可以使用 "],["select_for_update",[["c",null]]],[" 行锁保证正确性。"]]},{"children":[],"uri":"https://www.notion.so/4b6ef6a0e8474b399e11316369769971","type":"code","createdTime":1597824840000,"lastEditedTime":1597824960000,"title":[["with transaction.atomic():\n    # 仅在 transaction 内生效\n    Entry.objects.select_for_update().filter(name=\"Hello\")"]],"language":"Python","wrap":true},{"children":[],"uri":"https://www.notion.so/4a2ee6ace7844585bff6157546c6fef8","type":"text","createdTime":1605172860000,"lastEditedTime":1605172860000,"title":[]},{"children":[],"uri":"https://www.notion.so/c0f6214e5dd54747882de80cb11a28a6","type":"heading","createdTime":1597824960000,"lastEditedTime":1600159560000,"title":[["多对多和 "],["values()",[["c",null]]]],"depth":2},{"children":[],"uri":"https://www.notion.so/b5451ab310594767880957eff96ede3c","type":"text","createdTime":1600159560000,"lastEditedTime":1600159680000,"title":[["存在一个模型"]]},{"children":[],"uri":"https://www.notion.so/6ffb3c88aaa3446ebd20d1e508f223c0","type":"code","createdTime":1600159680000,"lastEditedTime":1600159740000,"title":[["class Foo(models.Model):\n    name = models.CharField(**some_params)\n    bars = models.ManyToManyField(**some_params)"]],"language":"Python","wrap":true},{"children":[],"uri":"https://www.notion.so/8de782dfa3b54d69b6cffc6ae140ed49","type":"text","createdTime":1600159800000,"lastEditedTime":1600159800000,"title":[["存在一条记录"]]},{"children":[],"uri":"https://www.notion.so/d876249ffb98409f9d95324f520ed017","type":"code","createdTime":1600159800000,"lastEditedTime":1600159800000,"title":[["foo:\n  name: tom\n  bars:\n    - a\n    - b "]],"language":"Python","wrap":true},{"children":[],"uri":"https://www.notion.so/f3ff6849c8b7470fa18e0c3f52df8ea1","type":"text","createdTime":1600159740000,"lastEditedTime":1600159860000,"title":[[" "],["values()",[["c",null]]],[" 预期返回"]]},{"children":[],"uri":"https://www.notion.so/6b21a3c726da4c8dad6e1163c439c86b","type":"code","createdTime":1600159860000,"lastEditedTime":1600159920000,"title":[["[\n    {\n        \"name\": \"tom\",\n        \"bars\": [\"a\", \"b\"]\n    }\n]"]],"language":"JSON","wrap":true},{"children":[],"uri":"https://www.notion.so/3809d28da28645419f78dbba51e0d12b","type":"text","createdTime":1600159860000,"lastEditedTime":1600159920000,"title":[["实际返回"]]},{"children":[],"uri":"https://www.notion.so/a71e2fdeb5034f78b5d99865cdac13f0","type":"code","createdTime":1600159920000,"lastEditedTime":1600159920000,"title":[["[\n    {\n        \"name\": \"tom\",\n        \"bars\": \"a\"\n    },\n    {\n        \"name\": \"tom\",\n        \"bars\": \"b\"\n    }\n]"]],"language":"JSON","wrap":true},{"children":[],"uri":"https://www.notion.so/27004c30c88346709d3bf829370b7888","type":"text","createdTime":1600159920000,"lastEditedTime":1600159980000,"title":[]},{"children":[],"uri":"https://www.notion.so/738a70d589904afcbbbdb30f8ecfa39d","type":"text","createdTime":1600159920000,"lastEditedTime":1600160040000,"title":[["没有什么太好的调整办法，只能注意 + 规避，详见: "]]},{"children":[],"uri":"https://www.notion.so/cafd2221b032459aa713abd10eca78f1","type":"bookmark","createdTime":1600159980000,"lastEditedTime":1600159980000,"link":"https://docs.djangoproject.com/en/1.11/ref/models/querysets/#values","title":"QuerySet API reference | Django documentation | Django","description":"Django provides a range of refinement methods that modify either the types of results returned by the or the way its SQL query is executed. Returns a new containing objects that do not match the given lookup parameters. The lookup parameters () should be in the format described in Field lookups below.","icon":"https://static.djangoproject.com/img/favicon.6dbf28c0650e.ico"},{"children":[],"uri":"https://www.notion.so/f5e80784e3ed4d8da9c8848c91e81d29","type":"image","createdTime":1600159980000,"lastEditedTime":1600160040000,"source":"https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2Fd55d79b9-fe83-43dd-8194-f02c9fea19d8%2FUntitled.png?width=873&table=block&id=f5e80784-e3ed-4d8d-a9c8-848c91e81d29","caption":[],"width":873,"height":-1,"fullWidth":false,"pageWidth":true,"aspectRatio":0.14776632302405499,"preserveScale":true},{"children":[],"uri":"https://www.notion.so/d370bbadd8c94550962dac8dab7a9113","type":"text","createdTime":1600422420000,"lastEditedTime":1600422420000,"title":[]},{"children":[],"uri":"https://www.notion.so/28af2acc9bde4c8892812c84c83053b0","type":"heading","createdTime":1600160040000,"lastEditedTime":1600422480000,"title":[["ORM 终究只是 ORM"]],"depth":2},{"children":[],"uri":"https://www.notion.so/9a5a3b4e875642d484fab88495b76d1c","type":"text","createdTime":1600422480000,"lastEditedTime":1602475080000,"title":[]},{"children":[],"uri":"https://www.notion.so/adb7c8a2d128496a98a8854eb14ba61a","type":"text","createdTime":1600422480000,"lastEditedTime":1602475080000,"title":[["我们要时刻记住, "],["orm",[["c",null]]],[" 只是做一个映射，有时候拿到的对象和我们预想并不能完全一致。"]]},{"children":[],"uri":"https://www.notion.so/4712925597d64d969ea8ff3926b60545","type":"text","createdTime":1600422540000,"lastEditedTime":1600422540000,"title":[]},{"children":[],"uri":"https://www.notion.so/f96ee6e9ede54b41aa09a583801590c2","type":"heading","createdTime":1600422540000,"lastEditedTime":1605172980000,"title":[["隐式转换"]],"depth":3},{"children":[],"uri":"https://www.notion.so/ac1ffa5d3c744f31ab2b524d62bd2981","type":"code","createdTime":1600422540000,"lastEditedTime":1605172980000,"title":[["class Foo(models.Model):\n    created = models.DateTimeField()\n\n# 这里先忽略 timezone 问题\nf1 = Foo(created='2020-09-18 09:46:23.544799')\n\n# 字符串会被存储，Django 做了隐式转换\nf1.save()\n\n# str\nprint(type(f1.created))\n\nf2 = Foo.objects.get(pk=f1.pk)\n\n# Datetime 对象！\nprint(type(f2.created))"]],"language":"Python","wrap":true},{"children":[],"uri":"https://www.notion.so/66918d838b1f477394587d6bf7143434","type":"text","createdTime":1600422960000,"lastEditedTime":1600422960000,"title":[]},{"children":[],"uri":"https://www.notion.so/bc92f0cabe6e4152ad65368b097e3954","type":"text","createdTime":1600422960000,"lastEditedTime":1600423320000,"title":[["通过以上的例子就能知道，我们自己创建的内存对象 "],["f1",[["c",null]]],[" 和通过 "],["orm",[["c",null]]],[" 拿出来的内存对象 "],["f2",[["c",null]]],[" 完全不是同一个东西，虽然他们都可以操作同一条数据库记录，但如果在内存对象里做比较就会有很多问题，比如下面的例子"]]},{"children":[],"uri":"https://www.notion.so/0902500aa1b947d584771b8b80cacd81","type":"text","createdTime":1600423740000,"lastEditedTime":1600423740000,"title":[]},{"children":[],"uri":"https://www.notion.so/b08dabe0bc2e4dff991b354ed8a89bef","type":"heading","createdTime":1600423740000,"lastEditedTime":1600423800000,"title":[["Mysql 低版本时间精度问题"]],"depth":3},{"children":[],"uri":"https://www.notion.so/6f628705322d4240b3abfd733b3f5d5e","type":"code","createdTime":1600423320000,"lastEditedTime":1600423560000,"title":[["class Foo(models.Model):\n    created = models.DateTimeField(auto_now_add=True)\n\n# 假定 Foo 表中已经存在了比较多的记录\nf = Foo.objects.create()\n\n# 我们预期是获取按照时间来排序，f 的前一条记录\no = Foo.objects.filter(created_lt=f.created).latest('created')\n\nassert o.pk == f.pk\n# mysql 版本大于 5.6.4 时 -> False\n# mysql 版本小于 5.6.4 时 -> True"]],"language":"Python","wrap":true},{"children":[],"uri":"https://www.notion.so/3ac46b8845474f4fafdd6c240f64e0e0","type":"text","createdTime":1600423560000,"lastEditedTime":1602324120000,"title":[["原因很简单，当 "],["mysql",[["c",null]]],[" 版本小于 "],["5.6.4",[["c",null]]],[" 时是不支持 "],["microseconds",[["c",null]]],[" 的，由于我们的 "],["f",[["c",null]]],[" 是内存对象，拿到的 "],["created",[["c",null]]],[" 又是有 "],["microseconds",[["c",null]]],[" 的，相当于我们在用 "],["2020-09-18 09:24:38.260779",[["c",null]]],[" 和 "],["2020-09-18 09:24:38.000000",[["c",null]]],[" 做比较， "],["o",[["c",null]]],[" 一直拿到的就是 "],["f",[["c",null]]],[" 对应的记录..."]]},{"children":[],"uri":"https://www.notion.so/ebbdf9ec362c4b8e9516856187b32f9c","type":"image","createdTime":1600423620000,"lastEditedTime":1600424040000,"source":"https://www.notion.so/signed/https%3A%2F%2Fs3-us-west-2.amazonaws.com%2Fsecure.notion-static.com%2F53b61d4b-0742-48a9-ac2c-54311236400f%2FUntitled.png?width=765&table=block&id=ebbdf9ec-362c-4b8e-9516-856187b32f9c","caption":[],"width":765,"height":-1,"fullWidth":false,"pageWidth":true,"aspectRatio":0.37254901960784315,"preserveScale":true},{"children":[],"uri":"https://www.notion.so/59a145b036f24843a503802a70de7f9b","type":"text","createdTime":1602324180000,"lastEditedTime":1602324180000,"title":[]},{"children":[],"uri":"https://www.notion.so/3439f10f660f442a81376effd1df43e2","type":"heading","createdTime":1602324120000,"lastEditedTime":1602470160000,"title":[["虚假的 "],[".query",[["c",null]]]],"depth":2},{"children":[],"uri":"https://www.notion.so/1145ecb06d1f4583bfc6672a58ef01c8","type":"text","createdTime":1602470160000,"lastEditedTime":1602470160000,"title":[]},{"children":[],"uri":"https://www.notion.so/03d2297c79734323b8a722e74648acc5","type":"text","createdTime":1602468780000,"lastEditedTime":1602470160000,"title":[["我们常常用 "],["queryset.query",[["c",null]]],[" 去检查复杂的查询语句，但实际上 "],["query",[["c",null]]],[" 属性并不能真实反应提交到 DB 中的 "],["sql",[["c",null]]],[" ，可以参考如下链接："]]},{"children":[],"uri":"https://www.notion.so/0f3a4e1856ab48549b5bf59c0e7db19b","type":"bookmark","createdTime":1602470040000,"lastEditedTime":1602470160000,"link":"https://code.djangoproject.com/ticket/17741","title":"QuerySet.query.__str__() does not generate valid MySQL query with dates","description":"If you have a date parameter in a QuerySet, the string of the query is not valid SQL in MySQL and will generate a warning.","icon":"https://code.djangoproject.com/favicon.ico"},{"children":[],"uri":"https://www.notion.so/ca6060538984435aaf4f04f044eff891","type":"text","createdTime":1602470100000,"lastEditedTime":1602470100000,"title":[]},{"children":[],"uri":"https://www.notion.so/ddf4b2136f7e4e43b8052f1261c32d26","type":"text","createdTime":1602470040000,"lastEditedTime":1605173040000,"title":[["那么如何调试提交到 DB 中的具体语句呢？"]]},{"children":[],"uri":"https://www.notion.so/5d9c0078b8e04957bdb150f7eb5caf52","type":"code","createdTime":1602470220000,"lastEditedTime":1602470220000,"title":[["from django.db import connection\n\n# 在语句提交之后，立即打印\nprint(connection.queries)"]],"language":"Python","wrap":true},{"children":[],"uri":"https://www.notion.so/334df6c6eb5d4c67a6018cbc5d6b2795","type":"text","createdTime":1602470160000,"lastEditedTime":1602470160000,"title":[]}],"uri":"https://www.notion.so/94a28416ce6b44ac91e15744eea88dd4","type":"page","createdTime":1591866376968,"lastEditedTime":1606476960000,"title":[["Django ORM：天使与魔鬼"]],"icon":"👹","cover":"https://images.unsplash.com/photo-1561411996-3794338f63cc?ixlib=rb-1.2.1&q=85&fm=jpg&crop=entropy&cs=srgb&ixid=eyJhcHBfaWQiOjYzOTIxfQ","fullWidth":true,"coverPosition":0.7072,"properties":{"!`\"w":[["Yes"]],"'2]%":[["abcd"]],":H`m":[["Yes"]],"xY$N":[["‣",[["d",{"type":"date","start_date":"2020-11-27"}]]]],"{iD?":[["web,django,orm,best-practice"]],"|Ay0":[["post"]],"title":[["Django ORM：天使与魔鬼"]]}}